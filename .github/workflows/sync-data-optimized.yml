name: Sync Data to koungs-day-web (Optimized)

on:
  workflow_run:
    # Quota, Subsidies ìŠ¤í¬ë˜í¼ ì™„ë£Œ í›„ ì‹¤í–‰
    workflows: ["EV Quota Scraper", "EV Subsidy Scraper"]
    types: [completed]

  # ìˆ˜ë™ í…ŒìŠ¤íŠ¸ìš©
  workflow_dispatch:

jobs:
  sync-data:
    runs-on: ubuntu-latest

    steps:
      # ========================================
      # 1. ìŠ¤í¬ë˜í¼ ë¦¬í¬ ì²´í¬ì•„ì›ƒ
      # ========================================
      - name: Checkout scraper repository
        uses: actions/checkout@v4
        with:
          path: scraper

      # ========================================
      # 2. ì›¹ ë¦¬í¬ ì²´í¬ì•„ì›ƒ
      # ========================================
      - name: Checkout koungs-day-web repository
        uses: actions/checkout@v4
        with:
          repository: koungsday/koungs-day-web
          token: ${{ secrets.PAT_TOKEN }}
          path: web

      # ========================================
      # 3. ë°ì´í„° íŒŒì¼ ë³µì‚¬
      # ========================================
      - name: Copy scraped data to web repo
        run: |
          echo "ğŸ“¥ Copying scraped data..."

          # public/data í´ë” í™•ì¸/ìƒì„±
          mkdir -p web/public/data

          # ì •ê·œí™”ëœ ë°ì´í„° íŒŒì¼ ë³µì‚¬
          cp scraper/data/quota.json web/public/data/ || echo "âš ï¸ quota.json not found"
          cp scraper/data/subsidies.json web/public/data/ || echo "âš ï¸ subsidies.json not found"
          cp scraper/data/vehicles.json web/public/data/ || echo "âš ï¸ vehicles.json not found"

          # ë³µì‚¬ëœ íŒŒì¼ í™•ì¸
          echo "ğŸ“ Files in web/public/data/:"
          ls -lh web/public/data/

      # ========================================
      # 4. ë³€ê²½ì‚¬í•­ ê°ì§€ (í•µì‹¬!)
      # ========================================
      - name: Check if data actually changed
        id: check_changes
        working-directory: web
        run: |
          # Git diffë¡œ ì‹¤ì œ ë³€ê²½ í™•ì¸
          if git diff --quiet public/data/quota.json public/data/subsidies.json public/data/vehicles.json 2>/dev/null; then
            # ë³€ê²½ ì—†ìŒ
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No data changes detected"
            echo "ğŸ’¡ Skipping commit to save Vercel deployment!"
          else
            # ë³€ê²½ ìˆìŒ
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Data changes detected:"

            # ì–´ë–¤ íŒŒì¼ì´ ë³€ê²½ë˜ì—ˆëŠ”ì§€ ë¡œê·¸
            if ! git diff --quiet public/data/quota.json 2>/dev/null; then
              echo "  ğŸ“ quota.json changed"
              git diff --stat public/data/quota.json
            fi

            if ! git diff --quiet public/data/subsidies.json 2>/dev/null; then
              echo "  ğŸ“ subsidies.json changed"
              git diff --stat public/data/subsidies.json
            fi

            if ! git diff --quiet public/data/vehicles.json 2>/dev/null; then
              echo "  ğŸ“ vehicles.json changed"
              git diff --stat public/data/vehicles.json
            fi
          fi

      # ========================================
      # 5. ì¡°ê±´ë¶€ ì»¤ë°‹ (ë³€ê²½ ìˆì„ ë•Œë§Œ!)
      # ========================================
      - name: Commit and push ONLY if data changed
        if: steps.check_changes.outputs.changed == 'true'
        working-directory: web
        run: |
          echo "ğŸ“¤ Committing changes to koungs-day-web..."

          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          # ë³€ê²½ëœ íŒŒì¼ë§Œ add
          git add public/data/quota.json public/data/subsidies.json public/data/vehicles.json

          # ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
          git commit -m "chore: Auto-update scraper data

          Updated at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')

          Data sources:
            - Quota: ë¬´ê³µí•´ì°¨ ëˆ„ë¦¬ì§‘ (í• ë‹¹ëŸ‰)
            - Vehicles: ì°¨ëŸ‰ ë§ˆìŠ¤í„° (êµ­ê³  ë³´ì¡°ê¸ˆ)
            - Subsidies: ì§€ì—­ë³„ ì§€ìì²´ ë³´ì¡°ê¸ˆ (ì •ê·œí™”)

          Synced from koungsday/longrange-scraper @ ${{ github.sha }}"

          # Push
          git push

          echo "âœ… Data synced and deployed to Vercel"

      # ========================================
      # 6. ê²°ê³¼ ë¡œê·¸
      # ========================================
      - name: Log sync result
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [ "${{ steps.check_changes.outputs.changed }}" == "true" ]; then
            echo "âœ… Sync completed: Data changed and committed"
            echo "ğŸš€ Vercel deployment triggered"
          else
            echo "â­ï¸  Sync skipped: No data changes"
            echo "ğŸ’° Saved 1 Vercel deployment!"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
