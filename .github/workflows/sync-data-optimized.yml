name: Sync Data to koungs-day-web (Optimized)

on:
  workflow_run:
    # Quota, Subsidies ìŠ¤í¬ë˜í¼ ì™„ë£Œ í›„ ì‹¤í–‰
    workflows: ["EV Quota Scraper", "EV Subsidy Scraper"]
    types: [completed]

  # ìˆ˜ë™ í…ŒìŠ¤íŠ¸ìš©
  workflow_dispatch:

jobs:
  sync-data:
    runs-on: ubuntu-latest

    steps:
      # ========================================
      # 1. ìŠ¤í¬ë˜í¼ ë¦¬í¬ ì²´í¬ì•„ì›ƒ
      # ========================================
      - name: Checkout scraper repository
        uses: actions/checkout@v4
        with:
          path: scraper

      # ========================================
      # 2. ì›¹ ë¦¬í¬ ì²´í¬ì•„ì›ƒ
      # ========================================
      - name: Checkout koungs-day-web repository
        uses: actions/checkout@v4
        with:
          repository: koungsday/koungs-day-web
          token: ${{ secrets.PAT_TOKEN }}
          path: web

      # ========================================
      # 3. ë°ì´í„° íŒŒì¼ ë³µì‚¬ (ì—°ë„ë³„ í´ë” ì§€ì›)
      # ========================================
      - name: Copy scraped data to web repo
        run: |
          echo "ğŸ“¥ Copying scraped data..."

          # public/data í´ë” í™•ì¸/ìƒì„±
          mkdir -p web/public/data

          # quota.json (ì‹¤ì‹œê°„ ë°ì´í„°)
          cp scraper/data/quota.json web/public/data/ || echo "âš ï¸ quota.json not found"

          # years.json (ì‚¬ìš© ê°€ëŠ¥í•œ ì—°ë„ ëª©ë¡)
          cp scraper/data/years.json web/public/data/ || echo "âš ï¸ years.json not found"

          # ì—°ë„ë³„ í´ë” ë³µì‚¬ (2025, 2026, ...)
          for year_dir in scraper/data/20*/; do
            if [ -d "$year_dir" ]; then
              year=$(basename "$year_dir")
              echo "ğŸ“ Copying $year data..."
              mkdir -p "web/public/data/$year"
              cp "$year_dir"*.json "web/public/data/$year/" 2>/dev/null || echo "  âš ï¸ No JSON files in $year"
            fi
          done

          # ë³µì‚¬ëœ íŒŒì¼ í™•ì¸
          echo "ğŸ“ Files in web/public/data/:"
          ls -lhR web/public/data/

      # ========================================
      # 4. ë³€ê²½ì‚¬í•­ ê°ì§€ (í•µì‹¬!)
      # ========================================
      - name: Check if data actually changed
        id: check_changes
        working-directory: web
        run: |
          # Git diffë¡œ ì‹¤ì œ ë³€ê²½ í™•ì¸ (ì „ì²´ data í´ë”)
          if git diff --quiet public/data/ 2>/dev/null && [ -z "$(git ls-files --others --exclude-standard public/data/)" ]; then
            # ë³€ê²½ ì—†ìŒ
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No data changes detected"
            echo "ğŸ’¡ Skipping commit to save Vercel deployment!"
          else
            # ë³€ê²½ ìˆìŒ
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Data changes detected:"

            # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ í‘œì‹œ
            git diff --stat public/data/ 2>/dev/null || true
            git ls-files --others --exclude-standard public/data/ || true
          fi

      # ========================================
      # 5. ì¡°ê±´ë¶€ ì»¤ë°‹ (ë³€ê²½ ìˆì„ ë•Œë§Œ!)
      # ========================================
      - name: Commit and push ONLY if data changed
        if: steps.check_changes.outputs.changed == 'true'
        working-directory: web
        run: |
          echo "ğŸ“¤ Committing changes to koungs-day-web..."

          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          # ëª¨ë“  data í´ë” ë³€ê²½ì‚¬í•­ add (ì—°ë„ë³„ í´ë” í¬í•¨)
          git add public/data/

          # ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
          git commit -m "chore: Auto-update scraper data

          Updated at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')

          Data sources:
            - Quota: ë¬´ê³µí•´ì°¨ ëˆ„ë¦¬ì§‘ (í• ë‹¹ëŸ‰)
            - Years: ì‚¬ìš© ê°€ëŠ¥í•œ ì—°ë„ ëª©ë¡
            - Vehicles: ì°¨ëŸ‰ ë§ˆìŠ¤í„° (ì—°ë„ë³„, êµ­ê³  ë³´ì¡°ê¸ˆ)
            - Subsidies: ì§€ì—­ë³„ ì§€ìì²´ ë³´ì¡°ê¸ˆ (ì—°ë„ë³„, ì •ê·œí™”)

          Synced from koungsday/longrange-scraper @ ${{ github.sha }}"

          # Push
          git push

          echo "âœ… Data synced and deployed to Vercel"

      # ========================================
      # 5.5. Redis ì¼ë³„ ìŠ¤ëƒ…ìƒ· ì €ì¥ (í•­ìƒ ì‹¤í–‰)
      # ========================================
      - name: Save daily quota snapshots to Redis
        run: |
          echo "ğŸ“Š Saving daily quota snapshots to Redis..."
          
          # URL ì„¤ì • (secretì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’)
          API_URL="${{ secrets.KOUNGS_DAY_WEB_URL }}"
          if [ -z "$API_URL" ]; then
            API_URL="https://www.vw-k.com"
          fi
          
          # API í˜¸ì¶œ
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${API_URL}/api/quota/sync" \
            -H "Authorization: Bearer ${{ secrets.SYNC_SECRET }}" \
            -H "Content-Type: application/json" \
            --max-time 30)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "Response: $BODY"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âš ï¸ Snapshot sync failed (HTTP $HTTP_CODE), but continuing..."
            echo "   This won't block data sync. Snapshots will be saved next time."
          else
            echo "âœ… Daily snapshots saved successfully"
            echo "   Data will be available for trend charts"
          fi


      # ========================================
      # 6. ê²°ê³¼ ë¡œê·¸
      # ========================================
      - name: Log sync result
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [ "${{ steps.check_changes.outputs.changed }}" == "true" ]; then
            echo "âœ… Sync completed: Data changed and committed"
            echo "ğŸš€ Vercel deployment triggered"
          else
            echo "â­ï¸  Sync skipped: No data changes"
            echo "ğŸ’° Saved 1 Vercel deployment!"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
